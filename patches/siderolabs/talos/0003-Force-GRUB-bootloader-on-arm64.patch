From b1603719906b8e4d97c379f62a62a5ff8bbe7b79 Mon Sep 17 00:00:00 2001
From: Martin Kuhn <martin@kuhn.host>
Date: Sat, 31 Jan 2026 10:17:40 +0100
Subject: [PATCH] Force GRUB bootloader on arm64

On arm64 platforms like RPi5, the UEFI firmware (U-Boot) exposes
/sys/firmware/efi but does not support EFI runtime SetVariable.
This causes NewAuto() to select sd-boot, which then fails when
trying to write EFI variables during installation.

Force GRUB on arm64 since it works correctly with the --no-nvram
flag (patched separately) and arm64-efi systems boot by convention.
---
 .../machined/pkg/runtime/v1alpha1/bootloader/bootloader.go   | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/internal/app/machined/pkg/runtime/v1alpha1/bootloader/bootloader.go b/internal/app/machined/pkg/runtime/v1alpha1/bootloader/bootloader.go
index 30ae77e6b..b906752a7 100644
--- a/internal/app/machined/pkg/runtime/v1alpha1/bootloader/bootloader.go
+++ b/internal/app/machined/pkg/runtime/v1alpha1/bootloader/bootloader.go
@@ -8,6 +8,7 @@ package bootloader
 import (
 	"fmt"
 	"os"
+	goruntime "runtime"
 
 	"github.com/siderolabs/go-blockdevice/v2/block"
 	"github.com/siderolabs/go-blockdevice/v2/partitioning/gpt"
@@ -73,6 +74,10 @@ func Probe(disk string, options options.ProbeOptions) (Bootloader, error) {
 
 // NewAuto returns a new bootloader based on auto-detection.
 func NewAuto() Bootloader {
+	if goruntime.GOARCH == "arm64" {
+		return grub.NewConfig()
+	}
+
 	if sdboot.IsUEFIBoot() {
 		return sdboot.New()
 	}
-- 
2.51.1

